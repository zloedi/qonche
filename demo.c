#define QONCHE_IMPLEMENTATION
#ifndef __EMSCRIPTEN__
#define QON_DEBUG
#endif
#define QON_DrawChar DrawChar
#include "qonche.h"

#include <stdio.h>
#include <SDL2/SDL.h>
#ifdef __EMSCRIPTEN__
#include <emscripten.h>
#endif

// apple II font

#define APPLEIIF_WIDTH 96
#define APPLEIIF_HEIGHT 64
#define APPLEIIF_CLMS 16
#define APPLEIIF_ROWS 8
#define APPLEIIF_CW (APPLEIIF_WIDTH/APPLEIIF_CLMS)
#define APPLEIIF_CH (APPLEIIF_HEIGHT/APPLEIIF_ROWS)

const unsigned char x_font[APPLEIIF_WIDTH * APPLEIIF_HEIGHT / 8] = {
    0x70,0x8f,0x1c,0xf3,0xef,0x9e,0x89,0xc0,0xa2,0x82,0x28,0x9c,
    0x89,0x48,0xa2,0x8a,0x08,0x20,0x88,0x80,0xa4,0x83,0x68,0xa2,
    0xaa,0x28,0xa0,0x8a,0x08,0x20,0x88,0x80,0xa8,0x82,0xac,0xa2,
    0xba,0x2f,0x20,0x8b,0xcf,0x20,0xf8,0x80,0xb0,0x82,0xaa,0xa2,
    0xb3,0xe8,0xa0,0x8a,0x08,0x26,0x88,0x80,0xa8,0x82,0x29,0xa2,
    0x82,0x28,0xa2,0x8a,0x08,0x22,0x88,0x88,0xa4,0x82,0x28,0xa2,
    0x7a,0x2f,0x1c,0xf3,0xe8,0x1e,0x89,0xc7,0x22,0xfa,0x28,0x9c,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xf1,0xcf,0x1c,0xfa,0x28,0xa2,0x8a,0x2f,0xbe,0x03,0xe0,0x00,
    0x8a,0x28,0xa2,0x22,0x28,0xa2,0x8a,0x20,0xb0,0x80,0x60,0x00,
    0x8a,0x28,0xa0,0x22,0x28,0xa2,0x51,0x41,0x30,0x40,0x62,0x00,
    0xf2,0x2f,0x1c,0x22,0x28,0xaa,0x20,0x82,0x30,0x20,0x65,0x00,
    0x82,0xaa,0x02,0x22,0x28,0xaa,0x50,0x84,0x30,0x10,0x68,0x80,
    0x82,0x49,0x22,0x22,0x25,0x36,0x88,0x88,0x30,0x08,0x60,0x00,
    0x81,0xa8,0x9c,0x21,0xc2,0x22,0x88,0x8f,0xbe,0x03,0xe0,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,
    0x00,0x85,0x14,0x23,0x04,0x08,0x20,0x82,0x00,0x00,0x00,0x00,
    0x00,0x85,0x14,0x7b,0x2a,0x08,0x40,0x4a,0x88,0x00,0x00,0x02,
    0x00,0x85,0x3e,0xa0,0x4a,0x08,0x80,0x27,0x08,0x00,0x00,0x04,
    0x00,0x80,0x14,0x70,0x84,0x00,0x80,0x22,0x3e,0x03,0xe0,0x08,
    0x00,0x80,0x3e,0x29,0x0a,0x80,0x80,0x27,0x08,0x20,0x00,0x10,
    0x00,0x00,0x14,0xf2,0x69,0x00,0x40,0x4a,0x88,0x20,0x00,0x20,
    0x00,0x80,0x14,0x20,0x66,0x80,0x20,0x82,0x00,0x40,0x02,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x70,0x87,0x3e,0x13,0xe3,0xbe,0x71,0xc0,0x00,0x10,0x04,0x1c,
    0x89,0x88,0x82,0x32,0x04,0x02,0x8a,0x20,0x00,0x20,0x02,0x22,
    0x98,0x80,0x84,0x53,0xc8,0x04,0x8a,0x22,0x08,0x43,0xe1,0x04,
    0xa8,0x83,0x0c,0x90,0x2f,0x08,0x71,0xe0,0x00,0x80,0x00,0x88,
    0xc8,0x84,0x02,0xf8,0x28,0x90,0x88,0x22,0x08,0x43,0xe1,0x08,
    0x88,0x88,0x22,0x12,0x28,0x90,0x88,0x40,0x08,0x20,0x02,0x00,
    0x71,0xcf,0x9c,0x11,0xc7,0x10,0x73,0x80,0x10,0x10,0x04,0x08,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x70,0x8f,0x1c,0xf3,0xef,0x9e,0x89,0xc0,0xa2,0x82,0x28,0x9c,
    0x89,0x48,0xa2,0x8a,0x08,0x20,0x88,0x80,0xa4,0x83,0x68,0xa2,
    0xaa,0x28,0xa0,0x8a,0x08,0x20,0x88,0x80,0xa8,0x82,0xac,0xa2,
    0xba,0x2f,0x20,0x8b,0xcf,0x20,0xf8,0x80,0xb0,0x82,0xaa,0xa2,
    0xb3,0xe8,0xa0,0x8a,0x08,0x26,0x88,0x80,0xa8,0x82,0x29,0xa2,
    0x82,0x28,0xa2,0x8a,0x08,0x22,0x88,0x88,0xa4,0x82,0x28,0xa2,
    0x7a,0x2f,0x1c,0xf3,0xe8,0x1e,0x89,0xc7,0x22,0xfa,0x28,0x9c,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xf1,0xcf,0x1c,0xfa,0x28,0xa2,0x8a,0x2f,0xbe,0x03,0xe0,0x00,
    0x8a,0x28,0xa2,0x22,0x28,0xa2,0x8a,0x20,0xb0,0x80,0x60,0x00,
    0x8a,0x28,0xa0,0x22,0x28,0xa2,0x51,0x41,0x30,0x40,0x62,0x00,
    0xf2,0x2f,0x1c,0x22,0x28,0xaa,0x20,0x82,0x30,0x20,0x65,0x00,
    0x82,0xaa,0x02,0x22,0x28,0xaa,0x50,0x84,0x30,0x10,0x68,0x80,
    0x82,0x49,0x22,0x22,0x25,0x36,0x88,0x88,0x30,0x08,0x60,0x00,
    0x81,0xa8,0x9c,0x21,0xc2,0x22,0x88,0x8f,0xbe,0x03,0xe0,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,
    0x40,0x08,0x00,0x08,0x03,0x00,0x80,0x81,0x20,0x60,0x00,0x00,
    0x20,0x08,0x00,0x08,0x04,0x80,0x80,0x00,0x20,0x20,0x00,0x00,
    0x11,0xcf,0x1e,0x79,0xc4,0x1c,0xf1,0x83,0x22,0x23,0x6f,0x1c,
    0x00,0x28,0xa0,0x8a,0x2f,0x22,0x88,0x81,0x24,0x22,0xa8,0xa2,
    0x01,0xe8,0xa0,0x8b,0xe4,0x22,0x88,0x81,0x38,0x22,0xa8,0xa2,
    0x02,0x28,0xa0,0x8a,0x04,0x1e,0x88,0x81,0x24,0x22,0xa8,0xa2,
    0x01,0xef,0x1e,0x79,0xe4,0x02,0x89,0xc9,0x22,0x72,0x28,0x9c,
    0x00,0x00,0x00,0x00,0x00,0x1c,0x00,0x06,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x0e,0x23,0x86,0x80,
    0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x18,0x20,0xcb,0x2a,
    0xf1,0xeb,0x9e,0xf2,0x28,0xa2,0x8a,0x2f,0x98,0x20,0xc0,0x14,
    0x8a,0x2c,0x20,0x42,0x28,0xa2,0x52,0x21,0x30,0x20,0x60,0x2a,
    0x8a,0x28,0x1c,0x42,0x28,0xaa,0x22,0x22,0x18,0x20,0xc0,0x14,
    0xf1,0xe8,0x02,0x4a,0x65,0x2a,0x51,0xe4,0x18,0x20,0xc0,0x2a,
    0x80,0x28,0x3c,0x31,0xa2,0x36,0x88,0x2f,0x8e,0x23,0x80,0x00,
    0x80,0x20,0x00,0x00,0x00,0x00,0x01,0xc0,0x00,0x20,0x00,0x00,
};

static SDL_Texture* CreateTexture( SDL_Renderer *renderer ) {
    SDL_SetHint( SDL_HINT_RENDER_SCALE_QUALITY, "0" );
    SDL_Texture *tex = SDL_CreateTexture( renderer, SDL_PIXELFORMAT_ABGR8888, 
                    SDL_TEXTUREACCESS_STATIC, APPLEIIF_WIDTH, APPLEIIF_HEIGHT );
    int pitch = APPLEIIF_WIDTH * 4;
    int bw = APPLEIIF_WIDTH / 8;
    unsigned char bytes[pitch * APPLEIIF_HEIGHT];
    for ( int y = 0, idx = 0; y < APPLEIIF_HEIGHT; y++ ) {
        for ( int x = 0; x < bw; x++ ) {
            int byte = x_font[x + y * bw];
            for ( int i = 0; i < 8; i++, idx += 4 ) {
                int alpha = ( byte & ( 1 << ( 7 - i ) ) ) ? 0xff : 0;
                bytes[idx + 0] = 0xff;
                bytes[idx + 1] = 0xff;
                bytes[idx + 2] = 0xff;
                bytes[idx + 3] = alpha;
            }
        }
    }
    SDL_UpdateTexture( tex, NULL, bytes, pitch );
    return tex;
}

typedef struct {
    int x, y;
    int scaleX, scaleY;
    int spaceX, spaceY;
} dcParam_t;

SDL_Renderer *x_renderer;
SDL_Window *x_window;
SDL_Texture *x_fontTex;
    
void DrawChar( int c, int x, int y, int isUnderCursor, void *data ) {
    dcParam_t *prm = data;
    int blink = SDL_GetTicks() & 256;
    int trueChar = ( isUnderCursor && blink ) ? 127 : c;
    int idx = trueChar & ( APPLEIIF_ROWS * APPLEIIF_CLMS - 1 );
    SDL_SetTextureAlphaMod( x_fontTex, 0xff );
    SDL_SetTextureBlendMode( x_fontTex, SDL_BLENDMODE_BLEND );
    SDL_Rect src = {
        idx % APPLEIIF_CLMS * APPLEIIF_CW,
        idx / APPLEIIF_CLMS * APPLEIIF_CH,
        APPLEIIF_CW,
        APPLEIIF_CH,
    };
    SDL_SetTextureColorMod( x_fontTex, 0xff, 0xff, 0xff );
    SDL_Rect dst1= { 
        prm->x + x * ( APPLEIIF_CW + prm->spaceX ) * prm->scaleX, 
        prm->y + y * ( APPLEIIF_CH + prm->spaceY ) * prm->scaleY, 
        APPLEIIF_CW * prm->scaleX, 
        APPLEIIF_CH * prm->scaleY,
    };
    SDL_RenderCopy( x_renderer, x_fontTex, &src, &dst1 );
}

void MainLoop( void *arg ) {
    int *quit = arg;
    SDL_Event event;
    while ( SDL_PollEvent( &event ) ) {
        int code = event.key.keysym.sym;
        switch( event.type ) {
            case SDL_TEXTINPUT:
                QON_Insert( event.text.text );
                break;
            case SDL_KEYDOWN:
                switch ( code ) {
                    case SDLK_RIGHT:     QON_MoveRight( 1 ); break;
                    case SDLK_LEFT:      QON_MoveLeft( 1 );  break;
                    case SDLK_DELETE:    QON_DelFront( 1 );  break;
                    case SDLK_BACKSPACE: QON_DelBack( 1 );   break;
                    case SDLK_PAGEUP:    QON_PageUp();       break;
                    case SDLK_PAGEDOWN:  QON_PageDown();     break;
                    case SDLK_RETURN: {
                        char buf[1024];
                        QON_EmitCommand( 1024, buf );
                    }
                    break;
                    default: break;
                }
                break;
            case SDL_QUIT:
                *quit = 1;
                break;
            default:
                break;
        }
    }

    SDL_SetRenderDrawColor( x_renderer, 64, 64, 64, 255 );
    SDL_RenderClear( x_renderer );

    // just to show param passing
    static dcParam_t prm = {
        .x = 10, .y = 10,
        .scaleX = 2, .scaleY = 2,
        .spaceX = 1, .spaceY = 3,
    };
    int cellW = prm.scaleX * ( APPLEIIF_CW + prm.spaceX );
    int cellH = prm.scaleY * ( APPLEIIF_CH + prm.spaceY );
    int w, h;
    SDL_GetWindowSize( x_window, &w, &h );
    QON_Draw( ( w - prm.x * 2 ) / cellW, ( h - prm.y * 2 ) / cellH, &prm );

    SDL_RenderPresent( x_renderer );
    SDL_Delay( 10 );
}

int main( int argc, char *argv[] ) {
#ifdef __EMSCRIPTEN__
    SDL_Init( SDL_INIT_VIDEO );
    SDL_CreateWindowAndRenderer( 640, 480, 0, &x_window, &x_renderer );
#else
    if ( SDL_InitSubSystem( SDL_INIT_VIDEO ) < 0 ) {
        fprintf( stderr, "SDL could not initialize video! SDL Error: %s\n", 
                                                            SDL_GetError() );
        return -1;
    }
    x_window = SDL_CreateWindow( "qonche demo",
                                    SDL_WINDOWPOS_UNDEFINED, 
                                    SDL_WINDOWPOS_UNDEFINED, 
                                    1024, 768,
                                    SDL_WINDOW_RESIZABLE );
    if( x_window == NULL ) {
        fprintf( stderr, "Window could not be created! SDL Error: %s\n", 
                                                            SDL_GetError() );
        return -1;
    }
    SDL_SetHint( SDL_HINT_RENDER_DRIVER, "opengl" );
    x_renderer = SDL_CreateRenderer( x_window, -1, SDL_RENDERER_ACCELERATED );
    if ( x_renderer == NULL ) {
        fprintf( stderr, "Renderer could not be created! SDL Error: %s\n", 
                                                            SDL_GetError() );
        return -1;
    }
    if ( SDL_InitSubSystem( SDL_INIT_TIMER ) < 0 ) {
        fprintf( stderr, "SDL could not initialize! SDL Error: %s", 
                                                            SDL_GetError() );
    }
    printf( "SDL initialized.\n" );
#endif

    x_fontTex = CreateTexture( x_renderer );
    int quit = 0;

#ifdef __EMSCRIPTEN__
    emscripten_set_main_loop_arg( MainLoop, &quit, -1, 1 );
#else
    while ( 1 ) {
        MainLoop( &quit );
        if ( quit ) {
            break;
        }
    }
#endif

    SDL_DestroyRenderer( x_renderer );
    SDL_DestroyWindow( x_window );
    SDL_Quit();

    return 0;
}
